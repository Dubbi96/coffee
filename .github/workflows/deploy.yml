name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:

    - name: Note Build Start Time
      id : start_time
      run : echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: 1ï¸âƒ£ Checkout Repository
      uses: actions/checkout@v3

    - name: 2ï¸âƒ£ Decode & Restore Service Account Key
      run: |
        echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > coffee-backend-key.json
        ls -l coffee-backend-key.json

    - name: 3ï¸âƒ£ Authenticate with GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: "${{ secrets.GCP_SA_KEY }}"

    - name: 4ï¸âƒ£ Configure Docker Authentication
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

    - name: 5ï¸âƒ£ Build Docker Image
      run: docker build -t asia-northeast3-docker.pkg.dev/tedserp/coffee-repo/dubbi-coffee:latest .

    - name: 6ï¸âƒ£ Push Docker Image to Artifact Registry
      run: docker push asia-northeast3-docker.pkg.dev/tedserp/coffee-repo/dubbi-coffee:latest

    - name: 7ï¸âƒ£ Deploy to Cloud Run
      run: |
        gcloud run deploy tedserp \
          --image=asia-northeast3-docker.pkg.dev/tedserp/coffee-repo/dubbi-coffee:latest \
          --platform=managed \
          --region=asia-northeast3 \
          --allow-unauthenticated \
          --service-account=my-cloud-service-account@tedserp.iam.gserviceaccount.com \
          --add-cloudsql-instances=tedserp:asia-northeast3:dubbi-coffee \
          --set-env-vars SPRING_PROFILES_ACTIVE=prod \
          --set-env-vars GOOGLE_APPLICATION_CREDENTIALS=/app/coffee-backend-key.json \
          --set-env-vars "JWT_SECRET=${{ secrets.JWT_SECRET }},DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }},DB_PASSWORD=${{ secrets.DB_PASSWORD }}"

    - name: ì¢…ë£Œ ì‹œê°„ ê¸°ë¡
      id: end_time
      run: |
        echo "END_TIME=$(date +%s)" >> $GITHUB_ENV
        echo "BUILD_TIME=$(( $(date +%s) - $START_TIME ))" >> $GITHUB_ENV


    - name : ë°°í¬ ì‹¤íŒ¨ ì‹œ ì¢…ë£Œ ì‹œê°„ ê¸°ë¡
      if: failure()
      run : |
          echo "END_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "BUILD_TIME=$(( $(date +%s) - $START_TIME ))" >> $GITHUB_ENV

    - name: ë¹Œë“œ ì‹¤íŒ¨ Discord ì•Œë¦¼
      if: failure()
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        embed-title: "ğŸŒ‹ **ë°°í¬ ì‹¤íŒ¨.**"
        embed-url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        embed-description: |
          ğ‘’ **ë°°í¬ í™˜ê²½:** `prod`
          ğ˜£ **ëŒ€ìƒ ë¸Œëœì¹˜:** `${{ github.ref_name }}`
          ğ‘¡ **ì†Œìš” ì‹œê°„:** `${{ env.BUILD_TIME }}ì´ˆ`
          ğ’ˆ **ì•¡ì…˜ ë§í¬:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        embed-color: "16711680"

    - name: ë¹Œë“œ ì„±ê³µ Discord ì•Œë¦¼
      if: success()
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        embed-title: "âœ… **ë°°í¬ ì„±ê³µ.**"
        embed-url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        embed-description: |
          ğ‘’ **ë°°í¬ í™˜ê²½:** `prod`
          ğ˜£ **ëŒ€ìƒ ë¸Œëœì¹˜:** `${{ github.ref_name }}`
          ğ‘¡ **ì†Œìš” ì‹œê°„:** `${{ env.BUILD_TIME }}ì´ˆ`
          ğ’ˆ **ì•¡ì…˜ ë§í¬:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        embed-color: "3066993"
