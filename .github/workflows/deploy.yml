name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Note Build Start Time
      id : start_time
      run : echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: 1ï¸âƒ£ Checkout Repository
      uses: actions/checkout@v3

    - name: â˜• Set up JDK 17 (for unit tests)
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: "17"
        cache: maven

    - name: ğŸ§ª Run unit tests (Maven)
      id: unit_tests
      run: |
        set -o pipefail
        ./mvnw -B test 2>&1 | tee maven-test.log

    - name: ğŸ§¾ Prepare unit test log tail (for Discord)
      if: always()
      run: |
        if [ -f maven-test.log ]; then
          {
            echo 'TEST_LOG_TAIL<<EOF'
            echo '```'
            tail -n 60 maven-test.log
            echo '```'
            echo 'EOF'
          } >> "$GITHUB_ENV"
        else
          echo "TEST_LOG_TAIL=(no maven-test.log found)" >> "$GITHUB_ENV"
        fi

    - name: 2ï¸âƒ£ Decode & Restore Service Account Key
      run: |
        echo "${{ secrets.GCP_SA_KEY }}" | base64 --decode > coffee-backend-key.json
        ls -l coffee-backend-key.json

    - name: 3ï¸âƒ£ Authenticate with GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: "${{ secrets.GCP_SA_KEY }}"

    - name: 4ï¸âƒ£ Configure Docker Authentication
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

    - name: 5ï¸âƒ£ Build Docker Image
      id: build_image
      run: |
        IMAGE_TAG=$(echo ${{ github.sha }} | cut -c1-7)
        IMAGE_LATEST="asia-northeast3-docker.pkg.dev/tedserp/coffee-repo/dubbi-coffee:latest"
        IMAGE_TAGGED="asia-northeast3-docker.pkg.dev/tedserp/coffee-repo/dubbi-coffee:${IMAGE_TAG}"
        docker build -t ${IMAGE_LATEST} -t ${IMAGE_TAGGED} .
        echo "IMAGE_LATEST=${IMAGE_LATEST}" >> $GITHUB_OUTPUT
        echo "IMAGE_TAGGED=${IMAGE_TAGGED}" >> $GITHUB_OUTPUT

    - name: 6ï¸âƒ£ Push Docker Image to Artifact Registry
      run: |
        docker push ${{ steps.build_image.outputs.IMAGE_LATEST }}
        docker push ${{ steps.build_image.outputs.IMAGE_TAGGED }}

    - name: 7ï¸âƒ£ Deploy to Cloud Run
      env:
        # ë°°í¬ ë‹¨ê³„ì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ ë³€ìˆ˜
        GCP_SA_KEY_B64: ${{ secrets.GCP_SA_KEY }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        # Service Account Keyë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
        GCP_SA_KEY_JSON=$(echo "$GCP_SA_KEY_B64" | base64 --decode)
        
        gcloud run deploy tedserp \
          --image=${{ steps.build_image.outputs.IMAGE_LATEST }} \
          --platform=managed \
          --region=asia-northeast3 \
          --allow-unauthenticated \
          --ingress=all \
          --service-account=my-cloud-service-account@tedserp.iam.gserviceaccount.com \
          --add-cloudsql-instances=tedserp:asia-northeast3:dubbi-coffee \
          --set-env-vars SPRING_PROFILES_ACTIVE=prod \
          --set-env-vars GOOGLE_APPLICATION_CREDENTIALS=/app/coffee-backend-key.json \
          --set-env-vars "GCP_SA_KEY_JSON=${GCP_SA_KEY_JSON}" \
          --set-env-vars "JWT_SECRET=${JWT_SECRET}" \
          --set-env-vars "DISCORD_WEBHOOK=${DISCORD_WEBHOOK}" \
          --set-env-vars "DB_PASSWORD=${DB_PASSWORD}"

    - name: ì¢…ë£Œ ì‹œê°„ ê¸°ë¡
      if: always()
      id: end_time
      run: |
        echo "END_TIME=$(date +%s)" >> $GITHUB_ENV
        echo "BUILD_TIME=$(( $(date +%s) - $START_TIME ))" >> $GITHUB_ENV


    - name: ë¹Œë“œ ì‹¤íŒ¨ Discord ì•Œë¦¼
      if: always() && failure()
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL != '' && secrets.DISCORD_WEBHOOK_URL || secrets.DISCORD_WEBHOOK }}
        embed-title: "ğŸŒ‹ **ë°°í¬ ì‹¤íŒ¨.**"
        embed-url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        embed-description: |
          ğ‘’ **ë°°í¬ í™˜ê²½:** `prod`
          ğ˜£ **ëŒ€ìƒ ë¸Œëœì¹˜:** `${{ github.ref_name }}`
          ğ‘¡ **ì†Œìš” ì‹œê°„:** `${{ env.BUILD_TIME }}ì´ˆ`
          ğ’ˆ **ì•¡ì…˜ ë§í¬:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          **í…ŒìŠ¤íŠ¸ ë¡œê·¸(ë§ˆì§€ë§‰ 60ì¤„):**
          ${{ env.TEST_LOG_TAIL }}
        embed-color: "16711680"

    - name: ë¹Œë“œ ì„±ê³µ Discord ì•Œë¦¼
      if: always() && success()
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL != '' && secrets.DISCORD_WEBHOOK_URL || secrets.DISCORD_WEBHOOK }}
        embed-title: "âœ… **ë°°í¬ ì„±ê³µ.**"
        embed-url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        embed-description: |
          ğ‘’ **ë°°í¬ í™˜ê²½:** `prod`
          ğ˜£ **ëŒ€ìƒ ë¸Œëœì¹˜:** `${{ github.ref_name }}`
          ğ‘¡ **ì†Œìš” ì‹œê°„:** `${{ env.BUILD_TIME }}ì´ˆ`
          ğ’ˆ **ì•¡ì…˜ ë§í¬:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        embed-color: "3066993"
